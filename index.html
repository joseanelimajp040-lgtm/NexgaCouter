<!DOCTYPE html>
<html class="dark" lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>J.A Pet Shop-Contador Nexgard</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="J.A Pet">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#112116">
    
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#17cf54",
                        "on-primary": "#003912",
                        "primary-container": "#00531e",
                        "on-primary-container": "#76ff98",
                        "background-light": "#f6f8f6",
                        "background-dark": "#112116",
                        "surface-dark": "#1c2b21", 
                        "surface-variant": "#2a3d31",
                        "outline-dark": "#8b938c",
                        "outline": "#8c9388",
                        "surface-container-high": "#28312b",
                        "surface-light": "#ffffff"
                    },
                    fontFamily: { "display": ["Manrope", "sans-serif"] },
                    borderRadius: {"DEFAULT": "1rem", "lg": "1.5rem", "xl": "2rem", "2xl": "3rem", "full": "9999px"},
                    boxShadow: {
                        "elevation-3": "0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px 0px rgba(0, 0, 0, 0.3)",
                    }
                },
            },
        }
    </script>

    <style>
        html, body {
            touch-action: manipulation; 
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }

        .view-section main, .menu-scroll {
            overscroll-behavior-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .state-layer { position: absolute; inset: 0; background-color: currentColor; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .group:hover .state-layer { opacity: 0.08; }
        .group:active .state-layer { opacity: 0.12; }
        
        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #2a3d31; border-radius: 4px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .safe-top { padding-top: max(env(safe-area-inset-top), 20px); }
        .safe-bottom { padding-bottom: max(env(safe-area-inset-bottom), 20px); }

        body { min-height: 100dvh; }
        
        .hidden-view { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleUp { from { transform: scale(0.95) translateY(10px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

        .animate-scale-up { animation: scaleUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        .ripple { position: relative; overflow: hidden; transform: translate3d(0, 0, 0); }
        .ripple:after { content: ""; display: block; position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none; background-image: radial-gradient(circle, #fff 10%, transparent 10.01%); background-repeat: no-repeat; background-position: 50%; transform: scale(10, 10); opacity: 0; transition: transform .5s, opacity 1s; }
        .ripple:active:after { transform: scale(0, 0); opacity: .2; transition: 0s; }
        
        input[type="checkbox"]:checked { background-color: #17cf54; border-color: #17cf54; }
        input[type="checkbox"] { border-radius: 4px; border-width: 2px; border-color: #8c9388; }

        /* Circular Chart for Modal */
        .circular-chart { display: block; margin: 0 auto; max-width: 100%; max-height: 250px; }
        .circle-bg { fill: none; stroke: currentColor; stroke-width: 3.8; }
        .circle { 
            fill: none; 
            stroke-width: 3.8; 
            stroke-linecap: round; 
            stroke-dasharray: 113.1; 
            stroke-dashoffset: 113.1; 
            transition: stroke-dashoffset 3s ease-in-out; 
        }
        .circle.filled { stroke-dashoffset: 28.275; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display antialiased min-h-screen text-gray-900 dark:text-white transition-colors duration-300 overflow-hidden selection:bg-primary selection:text-white">

    <div id="view-login" class="view-section w-full h-screen flex flex-col items-center justify-center p-4 fade-in">
        <main class="w-full max-w-md flex flex-col h-full gap-6 justify-center">
            <div class="flex flex-col items-center pt-8 pb-4">
                <div class="relative w-32 h-32 mb-6 rounded-2xl overflow-hidden shadow-xl ring-4 ring-surface-dark/50 bg-surface-dark flex items-center justify-center">
                    <span class="material-symbols-outlined text-[64px] text-primary">pets</span>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent pointer-events-none"></div>
                </div>
                <h1 class="text-gray-900 dark:text-white text-[28px] font-bold leading-tight text-center px-4">
                    Olá, balconista da <br/>
                    <span class="text-primary">J.A Pet Shop</span>
                </h1>
                <p class="text-gray-600 dark:text-gray-400 text-base font-medium leading-normal pt-3 text-center px-6">
                    Seja bem-vindo ao seu contador de Nexgard
                </p>
            </div>

            <form id="loginForm" class="flex flex-col gap-5 w-full px-2">
                <div class="relative group">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 ml-4" for="username">Nome de usuário</label>
                    <div class="relative flex items-center">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-500 dark:text-gray-400">
                            <span class="material-symbols-outlined text-[24px]">person</span>
                        </div>
                        <input class="block w-full rounded-2xl border-gray-300 dark:border-surface-variant bg-white dark:bg-surface-dark py-4 pl-12 pr-4 text-gray-900 dark:text-white placeholder-gray-400 focus:border-primary focus:ring-primary dark:focus:border-primary dark:focus:ring-primary sm:text-base shadow-sm transition-colors duration-200" id="username" placeholder="Digite seu usuário" type="text" required/>
                    </div>
                </div>
                
                <div class="relative group">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 ml-4" for="password">Senha</label>
                    <div class="relative flex items-center">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-500 dark:text-gray-400">
                            <span class="material-symbols-outlined text-[24px]">lock</span>
                        </div>
                        <input class="block w-full rounded-2xl border-gray-300 dark:border-surface-variant bg-white dark:bg-surface-dark py-4 pl-12 pr-12 text-gray-900 dark:text-white placeholder-gray-400 focus:border-primary focus:ring-primary dark:focus:border-primary dark:focus:ring-primary sm:text-base shadow-sm transition-colors duration-200" id="password" placeholder="••••••••" type="password" required/>
                        <button class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-500 dark:text-gray-400 hover:text-primary transition-colors" type="button" onclick="togglePassword()">
                            <span class="material-symbols-outlined text-[24px]" id="eyeIcon">visibility_off</span>
                        </button>
                    </div>
                </div>

                <div class="pt-4 flex flex-col gap-4">
                    <button class="relative group w-full flex justify-center py-4 px-4 border border-transparent rounded-full text-base font-bold text-on-primary bg-primary hover:bg-green-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary shadow-lg shadow-primary/20 transition-all duration-200 active:scale-[0.98]" type="submit">
                        <span class="state-layer rounded-full"></span>
                        Entrar
                    </button>
                </div>
            </form>
            
            <div class="pb-6 text-center mt-auto">
                <div class="flex items-center justify-center gap-2 text-xs text-gray-500 dark:text-gray-500">
                    <span class="material-symbols-outlined text-[16px]">verified_user</span>
                    <span>Seguro e verificado</span>
                </div>
            </div>
        </main>
    </div>

    <div id="view-dashboard" class="view-section hidden-view w-full min-h-screen flex flex-col bg-background-light dark:bg-background-dark fade-in">
        <div class="relative flex h-full min-h-screen w-full max-w-md mx-auto flex-col overflow-hidden shadow-2xl bg-background-light dark:bg-background-dark">
            
            <div id="menuOverlay" onclick="toggleMenu(false)" class="absolute inset-0 z-40 bg-black/60 backdrop-blur-[1px] transition-opacity duration-300 opacity-0 pointer-events-none"></div>
            
            <div id="menuDrawer" class="absolute left-0 top-0 bottom-0 z-50 h-full w-[85%] max-w-[340px] flex flex-col bg-[#1e2621] dark:bg-[#1e2621] rounded-r-3xl shadow-2xl transform -translate-x-full transition-transform duration-300 ease-out">
                <div class="h-12 w-full shrink-0 safe-top"></div>
                <div class="px-7 py-6 flex flex-col gap-1 shrink-0">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="flex items-center justify-center w-10 h-10 rounded-full bg-primary/20 text-primary">
                            <span class="material-symbols-outlined text-[24px]">pets</span>
                        </div>
                    </div>
                    <p class="text-[22px] font-bold leading-tight tracking-[-0.015em] text-[#e3e3e3]">J.A Pet Shop</p>
                    <p class="text-sm font-medium text-[#c4c7c5]">Vendas Nexgard</p>
                </div>
                <div class="flex-1 overflow-y-auto px-3 py-2 menu-scroll">
                    <ul class="flex flex-col gap-1">
                        <li>
                            <button onclick="toggleMenu(false)" class="w-full flex h-14 items-center gap-3 rounded-full px-4 bg-primary/20 text-primary hover:bg-primary/25 transition-colors ripple group">
                                <span class="material-symbols-outlined text-[24px] font-variation-settings-'FILL'1">dashboard</span>
                                <span class="text-sm font-bold leading-tight tracking-wide">Visão Geral</span>
                            </button>
                        </li>
                        <li>
                            <button onclick="navigateTo('view-export'); toggleMenu(false)" class="w-full flex h-14 items-center gap-3 rounded-full px-4 text-[#c4c7c5] hover:bg-[#424940]/50 hover:text-white transition-colors ripple">
                                <span class="material-symbols-outlined text-[24px]">picture_as_pdf</span>
                                <span class="text-sm font-medium leading-tight tracking-wide">Exportar lista em PDF</span>
                            </button>
                        </li>
                        <li>
                            <button class="w-full flex h-14 items-center gap-3 rounded-full px-4 text-[#c4c7c5] hover:bg-[#424940]/50 hover:text-white transition-colors ripple">
                                <span class="material-symbols-outlined text-[24px]">campaign</span>
                                <span class="text-sm font-medium leading-tight tracking-wide">Campanha</span>
                            </button>
                        </li>
                        <li class="py-2 px-4">
                            <div class="h-px bg-[#424940]"></div>
                        </li>
                        <li>
                            <button class="w-full flex h-14 items-center gap-3 rounded-full px-4 text-[#c4c7c5] hover:bg-[#424940]/50 hover:text-white transition-colors ripple">
                                <span class="material-symbols-outlined text-[24px]">settings</span>
                                <span class="text-sm font-medium leading-tight tracking-wide">Configurações</span>
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="p-4 mb-6 shrink-0 safe-bottom">
                    <button onclick="logout()" class="w-full flex h-12 items-center justify-center gap-2 rounded-full border border-[#424940] text-[#c4c7c5] hover:bg-[#424940] hover:text-white hover:border-transparent transition-all ripple">
                        <span class="material-symbols-outlined text-[20px]">logout</span>
                        <span class="text-sm font-bold">Sair</span>
                    </button>
                    <div class="mt-4 text-center">
                        <p class="text-xs text-[#8e918f]">Versão 2.4.0</p>
                    </div>
                </div>
            </div>
            
            <header class="flex items-center justify-between px-4 py-4 pt-8 bg-transparent z-10">
                <button onclick="toggleMenu(true)" class="flex items-center justify-center w-12 h-12 rounded-full text-gray-900 dark:text-white hover:bg-black/10 dark:hover:bg-white/10 active:scale-95 transition-transform">
                    <span class="material-symbols-outlined text-2xl">menu</span>
                </button>
                <h1 class="text-xl md:text-2xl font-normal tracking-wide text-center">Painel de Vendas</h1>
                <div class="w-12 h-12 rounded-full overflow-hidden bg-surface-variant border border-white/10 relative">
                    <div class="w-full h-full bg-primary flex items-center justify-center text-on-primary font-bold text-xl" id="userAvatar">U</div>
                </div>
            </header>

            <main class="flex-1 flex flex-col px-4 pb-28 overflow-y-auto no-scrollbar">
                
                <div class="flex flex-col items-center justify-center py-8">
                    <div class="relative flex items-center justify-center w-64 h-64">
                        <svg class="w-full h-full transform -rotate-90" viewbox="0 0 100 100">
                            <circle class="text-surface-variant/30 dark:text-surface-variant" cx="50" cy="50" fill="transparent" r="45" stroke="currentColor" stroke-width="8"></circle>
                            <circle id="progressCircle" class="progress-ring__circle" cx="50" cy="50" fill="transparent" r="45" stroke="#17cf54" stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round" stroke-width="8"></circle>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                            <span class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Vendas Totais</span>
                            <h2 class="text-4xl font-extrabold text-gray-900 dark:text-white tracking-tight" id="totalValue">R$ 0,00</h2>
                            <div class="mt-2 inline-flex items-center gap-1 px-3 py-1 rounded-full bg-primary/10 dark:bg-primary-container text-primary-700 dark:text-on-primary-container">
                                <span class="material-symbols-outlined text-sm font-bold">trending_up</span>
                                <span class="text-xs font-bold uppercase tracking-wide" id="goalPercentage">0% da Meta</span>
                            </div>
                        </div>
                    </div>
                    <p class="mt-4 text-center text-gray-500 dark:text-gray-400 text-sm">
                        Meta Diária: <span class="font-bold text-gray-900 dark:text-white">R$ 300,00</span>
                    </p>
                </div>

                <div class="flex items-center justify-between mb-4 mt-2 px-2">
                    <h3 class="text-lg font-medium text-gray-800 dark:text-gray-200">Resumo por Produto</h3>
                </div>

                <div class="flex flex-col gap-4">
                    <div onclick="abrirHistorico('Nexgard Spectra')" class="cursor-pointer group relative flex flex-col overflow-hidden rounded-xl bg-white dark:bg-surface-dark shadow-sm border border-gray-100 dark:border-white/5 transition-all hover:shadow-md hover:border-primary/30 active:scale-[0.98]">
                        <div class="flex items-center p-4 gap-4">
                            <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300">
                                <span class="material-symbols-outlined">medication</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="text-base font-bold text-gray-900 dark:text-white truncate">Nexgard Spectra</h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Toque para ver histórico</p>
                            </div>
                            <div class="text-right">
                                <p class="text-base font-bold text-gray-900 dark:text-white" id="qtySpectra">0</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Vendidos</p>
                            </div>
                        </div>
                        <div class="h-1 w-full bg-gray-100 dark:bg-surface-variant">
                            <div class="h-full bg-purple-500" id="barSpectra" style="width: 0%"></div>
                        </div>
                    </div>

                    <div onclick="abrirHistorico('Nexgard Tradicional')" class="cursor-pointer group relative flex flex-col overflow-hidden rounded-xl bg-white dark:bg-surface-dark shadow-sm border border-gray-100 dark:border-white/5 transition-all hover:shadow-md hover:border-primary/30 active:scale-[0.98]">
                        <div class="flex items-center p-4 gap-4">
                            <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300">
                                <span class="material-symbols-outlined">pets</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="text-base font-bold text-gray-900 dark:text-white truncate">Nexgard Tradicional</h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Toque para ver histórico</p>
                            </div>
                            <div class="text-right">
                                <p class="text-base font-bold text-gray-900 dark:text-white" id="qtyTraditional">0</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Vendidos</p>
                            </div>
                        </div>
                        <div class="h-1 w-full bg-gray-100 dark:bg-surface-variant">
                            <div class="h-full bg-orange-500" id="barTraditional" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </main>

            <nav class="absolute bottom-0 left-0 right-0 h-20 bg-white/80 dark:bg-[#151f18]/90 backdrop-blur-md border-t border-gray-200 dark:border-white/5 flex justify-around items-center px-6 z-20 pb-2">
                <button class="flex flex-col items-center justify-center w-16 h-full text-primary">
                    <span class="material-symbols-outlined text-[28px] font-variation-settings-FILL-1">dashboard</span>
                    <span class="text-[10px] font-medium mt-1">Início</span>
                </button>
                <div class="w-16"></div>
                <button onclick="logout()" class="flex flex-col items-center justify-center w-16 h-full text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors">
                    <span class="material-symbols-outlined text-[28px]">logout</span>
                    <span class="text-[10px] font-medium mt-1">Sair</span>
                </button>
            </nav>

            <div class="absolute bottom-8 left-1/2 -translate-x-1/2 z-30">
                <button onclick="navigateTo('view-new-sale')" class="flex items-center justify-center w-16 h-16 rounded-2xl bg-primary text-on-primary shadow-lg shadow-primary/40 hover:scale-105 hover:shadow-xl hover:shadow-primary/50 active:scale-95 transition-all duration-300">
                    <span class="material-symbols-outlined text-4xl">add</span>
                </button>
            </div>
        </div>
    </div>

    <div id="view-new-sale" class="view-section hidden-view w-full h-screen flex flex-col bg-background-light dark:bg-background-dark fade-in">
        <div class="max-w-md mx-auto w-full h-full flex flex-col relative">
            <header class="safe-top bg-background-light dark:bg-background-dark px-4 pb-2 sticky top-0 z-50">
                <div class="flex items-center justify-between h-14">
                    <button onclick="navigateTo('view-dashboard')" class="flex items-center justify-center size-10 rounded-full text-slate-900 dark:text-white hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                        <span class="material-symbols-outlined text-[24px]">arrow_back</span>
                    </button>
                    <h1 class="text-lg font-bold tracking-tight">Nova Venda</h1>
                    <div class="size-10"></div>
                </div>
            </header>
            <main class="flex-1 overflow-y-auto no-scrollbar px-4 pb-32">
                <div class="space-y-8 pt-4">
                    <section>
                        <h2 class="text-xl font-bold mb-4 px-1">Selecione o Produto</h2>
                        <div class="bg-surface-dark/10 dark:bg-surface-dark p-1 rounded-full flex relative overflow-hidden mb-6">
                            <div class="flex-1 relative z-10">
                                <input checked="" class="peer sr-only" id="prod-spectra" name="product" onchange="toggleProductList('spectra')" type="radio"/>
                                <label class="flex flex-col items-center justify-center py-3 px-4 rounded-full cursor-pointer transition-all duration-200 peer-checked:bg-primary peer-checked:text-background-dark peer-checked:shadow-md hover:bg-black/5 dark:hover:bg-white/5 peer-checked:hover:bg-primary" for="prod-spectra">
                                    <span class="text-sm font-bold tracking-wide">Nexgard Spectra</span>
                                </label>
                            </div>
                            <div class="flex-1 relative z-10">
                                <input class="peer sr-only" id="prod-tradicional" name="product" onchange="toggleProductList('tradicional')" type="radio"/>
                                <label class="flex flex-col items-center justify-center py-3 px-4 rounded-full cursor-pointer transition-all duration-200 peer-checked:bg-primary peer-checked:text-background-dark peer-checked:shadow-md hover:bg-black/5 dark:hover:bg-white/5 peer-checked:hover:bg-primary" for="prod-tradicional">
                                    <span class="text-sm font-bold tracking-wide">Tradicional</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-sm font-semibold text-slate-500 dark:text-gray-400 mb-3 px-1 uppercase tracking-wider">Peso do Animal</h3>
                            <div class="grid grid-cols-2 gap-3" id="list-spectra">
                                <label class="relative cursor-pointer group">
                                    <input class="peer sr-only" name="weight-selection" type="radio" value="96" data-name="2 - 3,5 kg"/>
                                    <div class="p-4 rounded-2xl bg-surface-dark/5 dark:bg-surface-dark border border-black/5 dark:border-white/5 peer-checked:border-primary peer-checked:bg-primary/10 dark:peer-checked:bg-primary/20 transition-all duration-200">
                                        <div class="flex flex-col gap-1"><span class="text-sm font-bold text-slate-900 dark:text-white">2 - 3,5 kg</span><span class="text-lg font-bold text-primary">R$ 96,00</span></div>
                                        <div class="absolute top-3 right-3 opacity-0 peer-checked:opacity-100 transition-opacity text-primary"><span class="material-symbols-outlined text-[20px] fill-1">check_circle</span></div>
                                    </div>
                                </label>
                                <label class="relative cursor-pointer group">
                                    <input class="peer sr-only" name="weight-selection" type="radio" value="100" data-name="3,6 - 7,5 kg"/>
                                    <div class="p-4 rounded-2xl bg-surface-dark/5 dark:bg-surface-dark border border-black/5 dark:border-white/5 peer-checked:border-primary peer-checked:bg-primary/10 dark:peer-checked:bg-primary/20 transition-all duration-200">
                                        <div class="flex flex-col gap-1"><span class="text-sm font-bold text-slate-900 dark:text-white">3,6 - 7,5 kg</span><span class="text-lg font-bold text-primary">R$ 100,00</span></div>
                                        <div class="absolute top-3 right-3 opacity-0 peer-checked:opacity-100 transition-opacity text-primary"><span class="material-symbols-outlined text-[20px] fill-1">check_circle</span></div>
                                    </div>
                                </label>
                                <label class="relative cursor-pointer group">
                                    <input class="peer sr-only" name="weight-selection" type="radio" value="112" data-name="7,6 - 15 kg"/>
                                    <div class="p-4 rounded-2xl bg-surface-dark/5 dark:bg-surface-dark border border-black/5 dark:border-white/5 peer-checked:border-primary peer-checked:bg-primary/10 dark:peer-checked:bg-primary/20 transition-all duration-200">
                                        <div class="flex flex-col gap-1"><span class="text-sm font-bold text-slate-900 dark:text-white">7,6 - 15 kg</span><span class="text-lg font-bold text-primary">R$ 112,00</span></div>
                                        <div class="absolute top-3 right-3 opacity-0 peer-checked:opacity-100 transition-opacity text-primary"><span class="material-symbols-outlined text-[20px] fill-1">check_circle</span></div>
                                    </div>
                                </label>
                                <label class="relative cursor-pointer group">
                                    <input class="peer sr-only" name="weight-selection" type="radio" value="135" data-name="15,1 - 30 kg"/>
                                    <div class="p-4 rounded-2xl bg-surface-dark/5 dark:bg-surface-dark border border-black/5 dark:border-white/5 peer-checked:border-primary peer-checked:bg-primary/10 dark:peer-checked:bg-primary/20 transition-all duration-200">
                                        <div class="flex flex-col gap-1"><span class="text-sm font-bold text-slate-900 dark:text-white">15,1 - 30 kg</span><span class="text-lg font-bold text-primary">R$ 135,00</span></div>
                                        <div class="absolute top-3 right-3 opacity-0 peer-checked:opacity-100 transition-opacity text-primary"><span class="material-symbols-outlined text-[20px] fill-1">check_circle</span></div>
                                    </div>
                                </label>
                                <label class="relative cursor-pointer group col-span-2">
                                    <input class="peer sr-only" name="weight-selection" type="radio" value="157" data-name="30,1 - 60 kg"/>
                                    <div class="p-4 rounded-2xl bg-surface-dark/5 dark:bg-surface-dark border border-black/5 dark:border-white/5 peer-checked:border-primary peer-checked:bg-primary/10 dark:peer-checked:bg-primary/20 transition-all duration-200 flex items-center justify-between">
                                        <div class="flex flex-col gap-1"><span class="text-sm font-bold text-slate-900 dark:text-white">30,1 - 60 kg</span><span class="text-lg font-bold text-primary">R$ 157,00</span></div>
                                        <div class="opacity-0 peer-checked:opacity-100 transition-opacity text-primary"><span class="material-symbols-outlined text-[24px] fill-1">check_circle</span></div>
                                    </div>
                                </label>
                            </div>
                            <div class="hidden grid grid-cols-2 gap-3" id="list-tradicional">
                                <label class="relative cursor-pointer group">
                                    <input class="peer sr-only" name="weight-selection" type="radio" value="89" data-name="2 - 4 kg"/>
                                    <div class="p-4 rounded-2xl bg-surface-dark/5 dark:bg-surface-dark border border-black/5 dark:border-white/5 peer-checked:border-primary peer-checked:bg-primary/10 dark:peer-checked:bg-primary/20 transition-all duration-200">
                                        <div class="flex flex-col gap-1"><span class="text-sm font-bold text-slate-900 dark:text-white">2 - 4 kg</span><span class="text-lg font-bold text-primary">R$ 89,00</span></div>
                                        <div class="absolute top-3 right-3 opacity-0 peer-checked:opacity-100 transition-opacity text-primary"><span class="material-symbols-outlined text-[20px] fill-1">check_circle</span></div>
                                    </div>
                                </label>
                                <label class="relative cursor-pointer group">
                                    <input class="peer sr-only" name="weight-selection" type="radio" value="95" data-name="4 - 10 kg"/>
                                    <div class="p-4 rounded-2xl bg-surface-dark/5 dark:bg-surface-dark border border-black/5 dark:border-white/5 peer-checked:border-primary peer-checked:bg-primary/10 dark:peer-checked:bg-primary/20 transition-all duration-200">
                                        <div class="flex flex-col gap-1"><span class="text-sm font-bold text-slate-900 dark:text-white">4 - 10 kg</span><span class="text-lg font-bold text-primary">R$ 95,00</span></div>
                                        <div class="absolute top-3 right-3 opacity-0 peer-checked:opacity-100 transition-opacity text-primary"><span class="material-symbols-outlined text-[20px] fill-1">check_circle</span></div>
                                    </div>
                                </label>
                                <label class="relative cursor-pointer group">
                                    <input class="peer sr-only" name="weight-selection" type="radio" value="119" data-name="10,1 - 25 kg"/>
                                    <div class="p-4 rounded-2xl bg-surface-dark/5 dark:bg-surface-dark border border-black/5 dark:border-white/5 peer-checked:border-primary peer-checked:bg-primary/10 dark:peer-checked:bg-primary/20 transition-all duration-200">
                                        <div class="flex flex-col gap-1"><span class="text-sm font-bold text-slate-900 dark:text-white">10,1 - 25 kg</span><span class="text-lg font-bold text-primary">R$ 119,00</span></div>
                                        <div class="absolute top-3 right-3 opacity-0 peer-checked:opacity-100 transition-opacity text-primary"><span class="material-symbols-outlined text-[20px] fill-1">check_circle</span></div>
                                    </div>
                                </label>
                                <label class="relative cursor-pointer group">
                                    <input class="peer sr-only" name="weight-selection" type="radio" value="137" data-name="25 - 50 kg"/>
                                    <div class="p-4 rounded-2xl bg-surface-dark/5 dark:bg-surface-dark border border-black/5 dark:border-white/5 peer-checked:border-primary peer-checked:bg-primary/10 dark:peer-checked:bg-primary/20 transition-all duration-200">
                                        <div class="flex flex-col gap-1"><span class="text-sm font-bold text-slate-900 dark:text-white">25 - 50 kg</span><span class="text-lg font-bold text-primary">R$ 137,00</span></div>
                                        <div class="absolute top-3 right-3 opacity-0 peer-checked:opacity-100 transition-opacity text-primary"><span class="material-symbols-outlined text-[20px] fill-1">check_circle</span></div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </section>
                    <section>
                        <h2 class="text-xl font-bold mb-4 px-1">Quantidade vendida</h2>
                        <div class="flex items-center gap-4">
                            <button onclick="alterarQtd(-1)" class="size-14 rounded-2xl bg-surface-dark/10 dark:bg-surface-dark border border-black/5 dark:border-white/5 flex items-center justify-center text-slate-900 dark:text-white hover:bg-primary/20 hover:text-primary hover:border-primary/50 transition-all active:scale-95">
                                <span class="material-symbols-outlined text-[28px]">remove</span>
                            </button>
                            <div class="flex-1 relative">
                                <input id="qtdInput" class="w-full h-16 bg-surface-dark/10 dark:bg-surface-dark border-2 border-transparent focus:border-primary focus:ring-0 rounded-2xl text-center text-3xl font-bold text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-gray-600 transition-all" type="number" value="1" readonly/>
                                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-sm font-medium text-slate-500 dark:text-gray-400 pointer-events-none">unid.</span>
                            </div>
                            <button onclick="alterarQtd(1)" class="size-14 rounded-2xl bg-primary text-background-dark border border-transparent flex items-center justify-center hover:bg-primary/90 hover:scale-105 shadow-lg shadow-primary/20 transition-all active:scale-95">
                                <span class="material-symbols-outlined text-[28px]">add</span>
                            </button>
                        </div>
                    </section>
                    <section>
                        <div class="flex items-baseline justify-between mb-4 px-1">
                            <h2 class="text-xl font-bold">Nota Fiscal</h2>
                            <span class="text-xs font-medium text-slate-500 dark:text-gray-400 bg-surface-dark/10 dark:bg-surface-variant px-2 py-1 rounded-md">Obrigatório</span>
                        </div>
                        <label class="group relative flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-slate-300 dark:border-surface-variant rounded-[2rem] cursor-pointer hover:bg-surface-dark/5 dark:hover:bg-surface-variant/30 hover:border-primary/50 transition-all duration-300" id="uploadArea">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6 text-center px-4">
                                <div class="mb-3 p-3 rounded-full bg-surface-dark/10 dark:bg-surface-dark text-slate-400 dark:text-gray-400 group-hover:text-primary group-hover:scale-110 transition-all duration-300">
                                    <span class="material-symbols-outlined text-[32px]">add_a_photo</span>
                                </div>
                                <p class="mb-1 text-sm font-semibold text-slate-900 dark:text-white" id="uploadText">Toque para anexar foto</p>
                                <p class="text-xs text-slate-500 dark:text-gray-400">Tire uma foto clara do cupom ou nota</p>
                            </div>
                            <input accept="image/*" class="hidden" type="file" onchange="fileUploaded(this)"/>
                        </label>
                    </section>
                </div>
            </main>
            <div class="absolute bottom-0 left-0 w-full p-4 safe-bottom z-40 bg-gradient-to-t from-background-light via-background-light to-transparent dark:from-background-dark dark:via-background-dark dark:to-transparent pt-8">
                <button onclick="salvarVenda()" class="w-full h-14 bg-primary hover:bg-green-400 active:scale-[0.98] text-background-dark rounded-full font-bold text-lg shadow-lg shadow-primary/25 flex items-center justify-center gap-2 transition-all duration-200 group">
                    <span class="material-symbols-outlined group-hover:rotate-12 transition-transform">check</span>
                    Registrar Venda
                </button>
            </div>
        </div>
    </div>

    <div id="view-history" class="view-section hidden-view w-full h-screen flex flex-col bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display fade-in">
        <header class="sticky top-0 z-50 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-md px-4 py-3 flex items-center justify-between border-b border-gray-200 dark:border-white/5">
            <button onclick="navigateTo('view-dashboard')" class="flex items-center justify-center p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                <span class="material-symbols-outlined text-2xl">arrow_back</span>
            </button>
            <h1 class="text-lg font-bold truncate px-2" id="historyPageTitle">Histórico</h1>
            <button class="flex items-center justify-center p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                <span class="material-symbols-outlined text-2xl">filter_list</span>
            </button>
        </header>
        <main class="flex-1 flex flex-col p-4 gap-6 pb-32 overflow-y-auto custom-scrollbar">
            <div class="shrink-0 relative overflow-hidden rounded-2xl bg-surface-dark p-6 border border-white/5 shadow-lg">
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-primary/20 rounded-full blur-3xl pointer-events-none"></div>
                <div class="flex items-start justify-between relative z-10 mb-4">
                    <div>
                        <span class="inline-block px-3 py-1 rounded-full bg-primary/20 text-primary text-xs font-bold mb-2 border border-primary/20">Em Estoque</span>
                        <h2 class="text-2xl font-bold leading-tight" id="historyProductName">Produto</h2>
                    </div>
                    <div class="bg-white/10 p-3 rounded-xl backdrop-blur-sm border border-white/5"><span class="material-symbols-outlined text-primary text-3xl">medication</span></div>
                </div>
                <div class="grid grid-cols-2 gap-3 relative z-10">
                    <div class="bg-background-dark/50 rounded-xl p-3 border border-white/5"><p class="text-white/60 text-xs font-medium mb-1">Vendas (Mês)</p><div class="flex items-baseline gap-2"><span class="text-xl font-bold text-white" id="historyTotalSales">0</span></div></div>
                    <div class="bg-background-dark/50 rounded-xl p-3 border border-white/5"><p class="text-white/60 text-xs font-medium mb-1">Total Arrecadado</p><div class="flex items-baseline gap-2"><span class="text-xl font-bold text-white" id="historyTotalRev">R$ 0,00</span></div></div>
                </div>
            </div>
            <div class="flex flex-col gap-4">
                <h3 class="text-lg font-bold px-1 flex items-center gap-2 text-slate-800 dark:text-white">Transações Recentes<span class="text-xs font-medium bg-surface-variant text-white/70 px-2 py-0.5 rounded-full">Geral</span></h3>
                <div id="historyList" class="flex flex-col gap-4 pb-4"></div>
                <div class="text-center mt-2" id="emptyHistoryMsg" style="display:none;"><p class="text-gray-500 text-sm">Nenhuma venda registrada.</p></div>
            </div>
        </main>
    </div>

    <div id="view-receipt" class="view-section hidden-view fixed inset-0 z-[60] bg-background-dark font-display text-white overflow-hidden flex flex-col antialiased fade-in">
        <header class="absolute top-0 left-0 w-full z-20 bg-gradient-to-b from-background-dark/90 via-background-dark/50 to-transparent pb-8 safe-top">
            <div class="px-4 py-2 flex items-center justify-between">
                <button onclick="navigateTo('view-history')" aria-label="Voltar" class="flex items-center justify-center p-2 rounded-full hover:bg-white/10 active:bg-white/20 transition-colors text-white"><span class="material-symbols-outlined !text-[28px]">arrow_back</span></button>
                <div class="flex-1 text-center pr-10"><h1 class="text-lg font-bold tracking-tight">Visualizar Nota Fiscal</h1></div>
            </div>
            <div class="px-4 text-center mt-1">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-surface-dark/60 backdrop-blur-sm border border-white/5 shadow-sm">
                    <span class="text-gray-300 text-sm font-medium" id="receiptDate">--</span>
                    <span class="w-1 h-1 rounded-full bg-gray-500"></span>
                    <span class="text-primary font-bold text-base" id="receiptValue">R$ --</span>
                </div>
                <p class="text-xs text-gray-400 mt-2 font-medium tracking-wide uppercase" id="receiptProduct">Produto</p>
            </div>
        </header>
        <main class="flex-1 relative w-full h-full flex items-center justify-center bg-background-dark overflow-hidden touch-none group">
            <div class="relative w-full h-full flex items-center justify-center p-4 transition-transform duration-200 ease-out">
                <div id="receiptImageContainer" class="relative w-full max-w-md aspect-[3/5] bg-surface-dark rounded-xl overflow-hidden shadow-2xl ring-1 ring-white/10 bg-center bg-cover bg-no-repeat">
                    <div id="noImagePlaceholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500"><span class="material-symbols-outlined text-6xl opacity-20">image_not_supported</span><p class="text-sm mt-2 opacity-40">Sem imagem anexada</p></div>
                </div>
            </div>
        </main>
        <footer class="absolute bottom-0 left-0 w-full z-20 safe-bottom">
            <div class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-background-dark via-background-dark/80 to-transparent -z-10 pointer-events-none"></div>
            <div class="flex flex-col items-center px-6 pb-6 pt-2 gap-6">
                <button onclick="navigateTo('view-history')" class="w-full max-w-xs h-14 bg-primary hover:bg-primary/90 active:scale-[0.98] text-background-dark font-bold text-lg rounded-full shadow-lg shadow-primary/20 flex items-center justify-center gap-2 transition-all"><span class="material-symbols-outlined">close</span><span>Fechar</span></button>
            </div>
        </footer>
    </div>

    <div id="view-export" class="view-section hidden-view w-full h-screen flex flex-col bg-background-light dark:bg-background-dark fade-in">
        <div class="relative w-full h-full flex flex-col flex-1 max-w-md mx-auto bg-background-light dark:bg-background-dark">
            <header class="flex items-center h-16 px-4 pt-2 shrink-0 safe-top">
                <button onclick="navigateTo('view-dashboard')" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-surface-variant-dark/30 ripple text-slate-900 dark:text-slate-100"><span class="material-symbols-outlined">arrow_back</span></button>
                <h1 class="ml-4 text-[22px] font-normal text-slate-900 dark:text-slate-100">Exportar PDF</h1>
            </header>
            <main class="flex-1 overflow-y-auto p-6 flex flex-col gap-8">
                <section class="flex flex-col gap-4">
                    <h2 class="text-sm font-medium text-primary tracking-wide uppercase">Período</h2>
                    <div class="flex flex-col gap-4">
                        <div class="relative group">
                            <label class="absolute -top-2 left-3 bg-background-light dark:bg-background-dark px-1 text-xs text-primary z-10" for="start-date">Data Inicial</label>
                            <div class="flex items-center border border-primary rounded-[4px] px-3 h-14 hover:border-primary-container focus-within:border-2 focus-within:border-primary bg-transparent transition-all"><input class="w-full bg-transparent border-none p-0 text-base text-slate-900 dark:text-slate-100 focus:ring-0 appearance-none" id="start-date" type="date"/><span class="material-symbols-outlined text-slate-500 dark:text-slate-400">calendar_today</span></div>
                        </div>
                        <div class="relative group">
                            <label class="absolute -top-2 left-3 bg-background-light dark:bg-background-dark px-1 text-xs text-outline group-hover:text-slate-900 dark:group-hover:text-slate-100 group-focus-within:text-primary z-10 transition-colors" for="end-date">Data Final</label>
                            <div class="flex items-center border border-outline rounded-[4px] px-3 h-14 hover:border-slate-900 dark:hover:border-slate-100 focus-within:border-2 focus-within:border-primary bg-transparent transition-all"><input class="w-full bg-transparent border-none p-0 text-base text-slate-900 dark:text-slate-100 focus:ring-0 appearance-none" id="end-date" type="date"/><span class="material-symbols-outlined text-slate-500 dark:text-slate-400">event</span></div>
                        </div>
                    </div>
                </section>
                <section class="flex flex-col gap-4">
                    <h2 class="text-sm font-medium text-primary tracking-wide uppercase">Filtrar Produtos</h2>
                    <div class="flex flex-col gap-3">
                        <label class="flex items-center justify-between p-4 rounded-xl bg-surface-container-high/30 border border-transparent hover:border-outline/30 cursor-pointer transition-all active:scale-[0.99] ripple">
                            <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-blue-100/10 flex items-center justify-center text-blue-400"><span class="material-symbols-outlined">pill</span></div><span class="text-base font-medium text-slate-900 dark:text-slate-100">Nexgard Spectra</span></div>
                            <input checked="" class="w-5 h-5 text-primary rounded focus:ring-primary focus:ring-offset-background-dark bg-transparent border-outline" type="checkbox" id="check-spectra"/>
                        </label>
                        <label class="flex items-center justify-between p-4 rounded-xl bg-surface-container-high/30 border border-transparent hover:border-outline/30 cursor-pointer transition-all active:scale-[0.99] ripple">
                            <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-orange-100/10 flex items-center justify-center text-orange-400"><span class="material-symbols-outlined">medication</span></div><span class="text-base font-medium text-slate-900 dark:text-slate-100">Nexgard Tradicional</span></div>
                            <input checked="" class="w-5 h-5 text-primary rounded focus:ring-primary focus:ring-offset-background-dark bg-transparent border-outline" type="checkbox" id="check-tradicional"/>
                        </label>
                    </div>
                </section>
                <div class="flex-grow"></div>
            </main>
            <div class="p-4 pb-8 bg-background-light dark:bg-background-dark mt-auto border-t border-outline/10 safe-bottom">
                <button onclick="gerarPDF()" class="w-full h-14 flex items-center justify-center gap-2 bg-primary hover:bg-primary/90 text-on-primary rounded-full font-bold text-[16px] shadow-lg shadow-primary/20 transition-all active:scale-[0.98] ripple"><span class="material-symbols-outlined">picture_as_pdf</span>Gerar PDF</button>
            </div>
        </div>
    </div>

    <div id="modal-loading" class="hidden-view fixed inset-0 z-[70] bg-black/60 backdrop-blur-[1px] flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="relative w-full max-w-[320px] bg-surface-light dark:bg-[#2C2C2C] rounded-3xl shadow-elevation-3 flex flex-col items-center pt-8 pb-6 px-6 text-center animate-scale-up">
            <div class="mb-6"><h2 class="text-xl font-medium text-gray-900 dark:text-gray-100">Exportando PDF</h2></div>
            <div class="relative w-32 h-32 mb-4 flex items-center justify-center">
                <svg class="circular-chart w-full h-full transform -rotate-90" viewbox="0 0 36 36">
                    <path class="circle-bg text-gray-200 dark:text-gray-600" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                    <path id="loading-circle" class="circle stroke-primary" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center flex-col"><span id="loading-percentage" class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight">0%</span></div>
            </div>
            <div class="flex flex-col gap-1 mb-8"><p class="text-sm font-medium text-gray-800 dark:text-gray-200">Processando dados...</p><p class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed max-w-[240px]">Aguarde enquanto preparamos seu resumo de vendas.</p></div>
        </div>
    </div>

    <div id="modal-success" class="hidden-view fixed inset-0 z-[70] flex items-end sm:items-center justify-center p-4 sm:p-6 bg-black/60 backdrop-blur-sm animate-fade-in">
        <div class="w-full max-w-sm bg-surface-light dark:bg-[#1e2f24] rounded-[28px] shadow-2xl overflow-hidden relative border border-gray-200 dark:border-white/10 transform transition-all animate-scale-up">
            <div class="flex flex-col items-center justify-center p-8 pt-10 text-center">
                <div class="relative mb-6">
                    <div class="absolute inset-0 bg-primary/20 rounded-full animate-pulse"></div>
                    <div class="relative flex items-center justify-center w-20 h-20 bg-primary/10 rounded-full text-primary"><span class="material-symbols-outlined text-5xl">check_circle</span></div>
                </div>
                <h2 class="text-2xl font-extrabold text-slate-900 dark:text-white mb-2 leading-tight">Download concluído!</h2>
                <p class="text-base text-gray-600 dark:text-gray-300 mb-8 leading-relaxed max-w-[260px]">O relatório de vendas Nexgard foi salvo com sucesso no seu dispositivo.</p>
                <div class="w-full flex flex-col gap-3">
                    <button onclick="navigateTo('view-dashboard'); document.getElementById('modal-success').classList.add('hidden-view')" class="w-full py-3.5 px-4 bg-primary hover:bg-green-500 active:bg-green-600 text-[#112217] text-base font-bold rounded-full transition-all duration-200 shadow-lg shadow-primary/25 flex items-center justify-center gap-2"><span>Concluído</span></button>
                    <button onclick="document.getElementById('modal-success').classList.add('hidden-view')" class="w-full py-3.5 px-4 bg-transparent hover:bg-gray-100 dark:hover:bg-white/5 text-slate-600 dark:text-gray-300 text-base font-semibold rounded-full transition-all duration-200">Voltar</button>
                </div>
            </div>
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary/0 via-primary to-primary/0 opacity-50"></div>
        </div>
    </div>

    <script>
        const META_DIARIA = 2000.00;
        let tempImageBase64 = null;

        function toggleMenu(show) {
            const overlay = document.getElementById('menuOverlay');
            const drawer = document.getElementById('menuDrawer');
            if (show) { overlay.classList.remove('opacity-0', 'pointer-events-none'); drawer.classList.remove('-translate-x-full'); } 
            else { overlay.classList.add('opacity-0', 'pointer-events-none'); drawer.classList.add('-translate-x-full'); }
        }

        function navigateTo(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden-view'));
            document.getElementById(viewId).classList.remove('hidden-view');
            if(viewId === 'view-dashboard') renderDashboard();
            if(viewId === 'view-new-sale') resetNewSaleForm();
        }

        function checkAuth() {
            const user = localStorage.getItem('usuarioAtivo');
            if(user) { navigateTo('view-dashboard'); } else { navigateTo('view-login'); }
        }

        function togglePassword() {
            const pwd = document.getElementById('password');
            const icon = document.getElementById('eyeIcon');
            if (pwd.type === 'password') { pwd.type = 'text'; icon.textContent = 'visibility'; } else { pwd.type = 'password'; icon.textContent = 'visibility_off'; }
        }

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const user = document.getElementById('username').value;
            if(user) { localStorage.setItem('usuarioAtivo', user); checkAuth(); }
        });

        function logout() {
            if(confirm("Tem certeza que deseja sair?")) { localStorage.removeItem('usuarioAtivo'); checkAuth(); }
        }

        function renderDashboard() {
            const user = localStorage.getItem('usuarioAtivo');
            if(user) document.getElementById('userAvatar').innerText = user.charAt(0).toUpperCase();

            const vendas = JSON.parse(localStorage.getItem('vendasPetShop')) || [];
            let totalValor = 0, qtdSpectra = 0, qtdTradicional = 0;

            vendas.forEach(venda => {
                totalValor += venda.total;
                if(venda.tipo === 'spectra') qtdSpectra += venda.quantidade;
                if(venda.tipo === 'tradicional') qtdTradicional += venda.quantidade;
            });

            document.getElementById('totalValue').innerText = totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('qtySpectra').innerText = qtdSpectra;
            document.getElementById('qtyTraditional').innerText = qtdTradicional;
            document.getElementById('barSpectra').style.width = Math.min((qtdSpectra / 20) * 100, 100) + '%';
            document.getElementById('barTraditional').style.width = Math.min((qtdTradicional / 20) * 100, 100) + '%';

            const circle = document.getElementById('progressCircle');
            const circumference = circle.r.baseVal.value * 2 * Math.PI;
            circle.style.strokeDasharray = `${circumference} ${circumference}`;
            let percent = (totalValor / META_DIARIA) * 100;
            if (percent > 100) percent = 100;
            circle.style.strokeDashoffset = circumference - (percent / 100) * circumference;
            document.getElementById('goalPercentage').innerText = `${((totalValor / META_DIARIA) * 100).toFixed(1)}% da Meta`;
        }

        function abrirHistorico(produtoNome) {
            const vendas = JSON.parse(localStorage.getItem('vendasPetShop')) || [];
            const user = localStorage.getItem('usuarioAtivo') || 'Usuário';
            
            const tipoFiltro = produtoNome.includes('Spectra') ? 'spectra' : 'tradicional';
            const vendasProduto = vendas.filter(v => v.tipo === tipoFiltro).reverse();

            const totalQtd = vendasProduto.reduce((acc, curr) => acc + curr.quantidade, 0);
            const totalRev = vendasProduto.reduce((acc, curr) => acc + curr.total, 0);

            document.getElementById('historyPageTitle').innerText = `Histórico: ${produtoNome.replace('Nexgard ', '')}`;
            document.getElementById('historyProductName').innerHTML = `${produtoNome} <br/><span class="text-white/60 text-lg font-medium">Histórico Geral</span>`;
            document.getElementById('historyTotalSales').innerText = totalQtd;
            document.getElementById('historyTotalRev').innerText = totalRev.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            const listContainer = document.getElementById('historyList');
            const emptyMsg = document.getElementById('emptyHistoryMsg');
            listContainer.innerHTML = '';

            if (vendasProduto.length === 0) {
                emptyMsg.style.display = 'block';
            } else {
                emptyMsg.style.display = 'none';
                vendasProduto.forEach(venda => {
                    const dataObj = new Date(venda.data);
                    const dia = dataObj.toLocaleDateString('pt-BR', {day: '2-digit', month: 'short'});
                    const hora = dataObj.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
                    const idCurto = venda.id.toString().slice(-4);
                    const iniciais = user.slice(0, 2).toUpperCase();

                    const itemHTML = `
                    <div class="group relative overflow-hidden rounded-2xl bg-surface-dark border border-white/5 hover:border-primary/30 transition-all duration-300">
                        <div class="p-4 flex flex-col gap-4">
                            <div class="flex items-center justify-between gap-3">
                                <div class="flex items-center gap-3 flex-1 min-w-0">
                                    <div class="flex items-center justify-center w-12 h-12 rounded-xl bg-surface-variant text-primary shrink-0"><span class="material-symbols-outlined">receipt_long</span></div>
                                    <div class="flex flex-col min-w-0">
                                        <p class="font-bold text-base truncate text-white group-hover:text-primary transition-colors">Venda #${idCurto}</p>
                                        <div class="flex items-center gap-1.5 text-sm text-white/50"><span class="material-symbols-outlined text-[14px]">calendar_today</span><span class="truncate">${dia} • ${hora}</span></div>
                                        <p class="text-xs text-gray-400 mt-1">${venda.produtoDetalhe}</p>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end shrink-0">
                                    <span class="text-lg font-bold text-white">${venda.total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                                    <span class="text-xs font-medium text-primary bg-primary/10 px-2 py-0.5 rounded-full mt-1">${venda.quantidade} un</span>
                                </div>
                            </div>
                            <div class="h-px w-full bg-white/5"></div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-[10px] font-bold text-white border border-white/10">${iniciais}</div><span class="text-sm text-white/70">${user}</span></div>
                                <button onclick="verNota(${venda.id})" class="flex items-center gap-1.5 text-primary text-sm font-bold hover:bg-primary/10 px-3 py-1.5 rounded-full transition-colors active:scale-95"><span class="material-symbols-outlined text-lg">visibility</span>Ver Nota</button>
                            </div>
                        </div>
                    </div>`;
                    listContainer.innerHTML += itemHTML;
                });
            }
            navigateTo('view-history');
        }

        function verNota(vendaId) {
            const vendas = JSON.parse(localStorage.getItem('vendasPetShop')) || [];
            const venda = vendas.find(v => v.id === vendaId);
            if(venda) {
                const dataObj = new Date(venda.data);
                document.getElementById('receiptDate').innerText = dataObj.toLocaleDateString('pt-BR', {day: '2-digit', month: 'short'});
                document.getElementById('receiptValue').innerText = venda.total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                document.getElementById('receiptProduct').innerText = venda.produtoDetalhe;

                const imgContainer = document.getElementById('receiptImageContainer');
                const placeholder = document.getElementById('noImagePlaceholder');
                
                if (venda.imagemBase64) {
                    imgContainer.style.backgroundImage = `url('${venda.imagemBase64}')`;
                    placeholder.style.display = 'none';
                } else {
                    imgContainer.style.backgroundImage = 'none';
                    placeholder.style.display = 'flex';
                }
                navigateTo('view-receipt');
            }
        }

        // --- GERAÇÃO DE PDF ---
        function gerarPDF() {
            const inicio = document.getElementById('start-date').value;
            const fim = document.getElementById('end-date').value;
            const checkSpectra = document.getElementById('check-spectra').checked;
            const checkTrad = document.getElementById('check-tradicional').checked;
            const user = localStorage.getItem('usuarioAtivo') || 'Usuário';

            if(!inicio || !fim) { alert("Por favor, selecione as datas inicial e final."); return; }

            const vendas = JSON.parse(localStorage.getItem('vendasPetShop')) || [];
            
            // Filtro
            const filteredVendas = vendas.filter(v => {
                const dataVenda = new Date(v.data).toISOString().split('T')[0];
                const tipoMatch = (v.tipo === 'spectra' && checkSpectra) || (v.tipo === 'tradicional' && checkTrad);
                return dataVenda >= inicio && dataVenda <= fim && tipoMatch;
            });

            if(filteredVendas.length === 0) { alert("Nenhuma venda encontrada para o período selecionado."); return; }

            // Group by Date
            const grouped = {};
            filteredVendas.forEach(v => {
                const dataKey = new Date(v.data).toLocaleDateString('pt-BR');
                if(!grouped[dataKey]) grouped[dataKey] = [];
                grouped[dataKey].push(v);
            });

            // Start Loading UI
            const loadingModal = document.getElementById('modal-loading');
            const circle = document.getElementById('loading-circle');
            const percentageText = document.getElementById('loading-percentage');
            circle.classList.remove('filled'); void circle.offsetWidth; percentageText.innerText = '0%';
            loadingModal.classList.remove('hidden-view');
            setTimeout(() => { circle.classList.add('filled'); }, 50);

            // Generate PDF Object
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.text("Relatório de Vendas - J.A Pet Shop", 14, 20);
            doc.setFontSize(11);
            doc.text(`Período: ${new Date(inicio).toLocaleDateString('pt-BR')} a ${new Date(fim).toLocaleDateString('pt-BR')}`, 14, 30);
            doc.text(`Gerado por: ${user}`, 14, 36);

            let finalY = 40;

            Object.keys(grouped).sort().reverse().forEach(date => {
                doc.setFontSize(14);
                doc.setTextColor(23, 207, 84); // Primary Green
                doc.text(date, 14, finalY + 10);
                
                const tableData = grouped[date].map(v => [
                    new Date(v.data).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}),
                    `#${v.id.toString().slice(-4)}`,
                    v.produtoDetalhe,
                    v.quantidade,
                    v.total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
                    user
                ]);

                doc.autoTable({
                    startY: finalY + 15,
                    head: [['Hora', 'ID', 'Produto', 'Qtd', 'Total', 'Vendedor']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [23, 207, 84], textColor: [0, 57, 18] },
                    styles: { fontSize: 9 },
                    columnStyles: { 2: { cellWidth: 70 } } // Wider column for product name
                });

                finalY = doc.lastAutoTable.finalY + 5;
            });

            // Timer & Download
            let progress = 0;
            const interval = setInterval(() => {
                progress += 1;
                percentageText.innerText = `${progress}%`;
                if (progress >= 100) {
                    clearInterval(interval);
                    doc.save('Relatorio_Vendas_JAPet.pdf');
                    setTimeout(() => {
                        loadingModal.classList.add('hidden-view');
                        document.getElementById('modal-success').classList.remove('hidden-view');
                        circle.classList.remove('filled');
                    }, 500);
                }
            }, 30); 
        }

        // --- NOVA VENDA ---
        function resetNewSaleForm() {
            document.getElementById('qtdInput').value = 1;
            document.getElementById('prod-spectra').checked = true;
            toggleProductList('spectra'); 
            document.querySelectorAll('input[name="weight-selection"]').forEach(el => el.checked = false);
            document.getElementById('uploadText').innerText = "Toque para anexar foto";
            document.getElementById('uploadArea').classList.remove('border-primary', 'bg-primary/5');
            tempImageBase64 = null;
        }

        function toggleProductList(type) {
            const listSpectra = document.getElementById('list-spectra');
            const listTradicional = document.getElementById('list-tradicional');
            document.querySelectorAll('input[name="weight-selection"]').forEach(el => el.checked = false);
            if (type === 'spectra') {
                listSpectra.classList.remove('hidden'); listSpectra.classList.add('grid');
                listTradicional.classList.add('hidden'); listTradicional.classList.remove('grid');
            } else {
                listSpectra.classList.add('hidden'); listSpectra.classList.remove('grid');
                listTradicional.classList.remove('hidden'); listTradicional.classList.add('grid');
            }
        }

        function alterarQtd(val) {
            const input = document.getElementById('qtdInput');
            let nova = parseInt(input.value) + val;
            if(nova < 1) nova = 1;
            input.value = nova;
        }

        function fileUploaded(input) {
            if(input.files && input.files[0]) {
                const file = input.files[0];
                document.getElementById('uploadText').innerText = file.name;
                document.getElementById('uploadArea').classList.add('border-primary', 'bg-primary/5');
                const reader = new FileReader();
                reader.onloadend = function() { tempImageBase64 = reader.result; }
                reader.readAsDataURL(file);
            }
        }

        function salvarVenda() {
            const isSpectra = document.getElementById('prod-spectra').checked;
            const tipo = isSpectra ? 'spectra' : 'tradicional';
            const selectedWeight = document.querySelector('input[name="weight-selection"]:checked');
            
            if (!selectedWeight) { alert("Por favor, selecione o peso do animal."); return; }

            const precoUnitario = parseFloat(selectedWeight.value);
            const produtoNomeDetalhe = (isSpectra ? "Nexgard Spectra " : "Nexgard Tradicional ") + selectedWeight.getAttribute('data-name');
            const qtd = parseInt(document.getElementById('qtdInput').value);
            const total = qtd * precoUnitario;

            const novaVenda = {
                id: Date.now(),
                data: new Date().toISOString(),
                tipo: tipo,
                produtoDetalhe: produtoNomeDetalhe,
                produto: isSpectra ? 'Nexgard Spectra' : 'Nexgard Tradicional',
                quantidade: qtd,
                total: total,
                imagemBase64: tempImageBase64
            };

            const vendas = JSON.parse(localStorage.getItem('vendasPetShop')) || [];
            vendas.push(novaVenda);
            try {
                localStorage.setItem('vendasPetShop', JSON.stringify(vendas));
                alert(`Venda Registrada!\n${produtoNomeDetalhe}\nTotal: R$ ${total.toFixed(2)}`);
                navigateTo('view-dashboard');
            } catch (e) { alert("Erro: A imagem pode ser muito grande."); }
        }

        window.addEventListener('load', () => {
            checkAuth();
            const hoje = new Date().toISOString().split('T')[0];
            const inicioMes = new Date(); inicioMes.setDate(1);
            document.getElementById('end-date').value = hoje;
            document.getElementById('start-date').value = inicioMes.toISOString().split('T')[0];
        });
    </script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('PWA Service Worker registrado!', reg))
                    .catch(err => console.log('Erro ao registrar PWA:', err));
            });
        }
    </script>
</body>
</html>
